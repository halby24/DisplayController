# 文字エンコーディング問題への対処方針 (2025/03/02)

## 問題の分析
1. ビルドエラーの主な原因
   - 文字列リテラルの改行による構文エラー
   - 日本語文字列のエンコーディング問題
   - Windows APIとの文字コード変換の不一致

2. 影響範囲
   - ソースファイル全般（.cpp, .h）
   - CMakeビルド設定
   - プラグインのビルド設定

## 対処方針の決定

### 1. ビルドシステムレベルの対応
- C++20を標準として採用
  - 理由：より良い文字列処理とUnicodeサポート
  - 影響：すべてのプロジェクトコンポーネント

- コンパイラオプションの統一
  ```cmake
  if(MSVC)
      add_compile_options(/utf-8 /source-charset:utf-8 /execution-charset:utf-8)
      add_compile_definitions(_UNICODE UNICODE)
  endif()
  ```

### 2. ソースコードレベルの対応
- 文字列リテラルの扱い
  - 日本語文字列は通常の文字列リテラルとして記述（u8プレフィックスは使用しない）
  - 必要に応じてStringUtils::Utf8ToWideを使用
  - 改行を含む文字列は1行で記述または文字列連結演算子を使用
  - 理由：u8プレフィックスはMSVCでの文字列リテラルの扱いに問題を引き起こす

### 2.1 コンパイラオプションの最適化
- UTF-8関連オプションの重複を解消
  - /utf-8オプションのみを使用（/source-charset:utf-8は削除）
  - 理由：/utf-8は/source-charset:utf-8と/execution-charset:utf-8の短縮形
  - 影響：ビルドエラーの解消とコンパイラ設定の簡素化

### 2.2 インクルードパスの改善
- プラグインのインクルードパス設定を修正
  - ${CMAKE_SOURCE_DIR}を追加してソースディレクトリへの相対パスを解決
  - 理由：プラグインからメインプロジェクトのヘッダーファイルを正しく参照するため

- Windows API呼び出し
  - すべてUnicode版（*W関数）に統一
  - TCHAR関連の型は使用しない
  - 文字列バッファはwchar_tベースで処理

### 3. ファイル保存形式
- すべてのソースファイルをUTF-8（BOMあり）で保存
- 改行コードはCRLFに統一

## 実装手順

1. ビルドシステムの更新
   - メインのCMakeLists.txt
   - 各プラグインのCMakeLists.txt

2. ソースファイルの修正
   - BrightnessDaemon.cpp
   - ConfigManager.cpp
   - その他の関連ファイル

3. 文字列処理の統一
   - Windows API呼び出しの修正
   - 文字列リテラルの改行問題の解決

## 検証方法
1. 全ファイルのエンコーディング確認
2. ビルドテスト
3. 日本語文字列の表示確認
4. プラグインの動作確認

## リスク管理
- 既存の文字列処理への影響
- プラグインとの互換性
- パフォーマンスへの影響

## 今後の課題
1. コードレビュープロセスの改善
2. エンコーディングチェックの自動化
3. 文字列処理ガイドラインの作成
