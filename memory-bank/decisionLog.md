# 設計上の決定記録

## 2025/03/04 - HttpClientの認証と通信の信頼性向上

### 背景
- SwitchBot APIとの通信において、認証と通信の信頼性を向上させる必要がある
- タイムスタンプがミリ秒単位で変わる可能性があり、1回の処理内で一貫性を保つ必要がある
- nonceの生成方法を改善し、より安全な認証を実現する必要がある

### 決定事項
1. nonceにUUIDを使用
   - 以前のランダム文字列生成からUUID生成に変更
   - Windows APIのCoCreateGuid()を使用して一意のIDを生成
   - より予測困難で一意性の高いnonceを実現

2. SetupHeadersにcharset: utf-8を追加
   - APIリクエストのエンコーディングを明示的に指定
   - 国際文字を含むデータの正確な処理を保証

3. Timestampを引数で受け取るように変更
   - GetTimestamp()の結果を引数として渡すように変更
   - 同じ処理内で一貫したタイムスタンプを使用
   - ミリ秒単位で変わる可能性のあるタイムスタンプの一貫性を保証

### 実装方針
1. HttpClient.hの変更
   - generateUUID()メソッドの追加
   - SetupHeadersメソッドの引数にtimestampを追加

2. HttpClient.cppの変更
   - UUID生成関数の実装
   - SetupHeadersにcharset: utf-8ヘッダーの追加
   - Get()メソッド内でタイムスタンプを一度だけ取得し、それを使い回す

### 影響範囲
- HttpClient.h/cpp
- SwitchBot APIとの通信処理
- 認証関連のセキュリティ

## 2025/03/04 - モニター設定の自動追加機能の設計

### 背景
- 新しいモニターを接続した際に手動で設定を追加する必要がある
- モニターの識別が技術的な情報（デバイスID等）に依存している
- 設定ファイルの破損時のリカバリー機能が不足

### 決定事項
1. モニター識別子の設計
   - 人間が理解しやすい形式を採用
   - 製造元名、製品名、サイズ、役割の組み合わせ
   - 例：`DELL P2419H 24inch Primary`
   - フォールバック：`Display 1 24inch`

2. 設定ファイルの自動バックアップ機能
   - 設定変更時に自動バックアップを作成
   - タイムスタンプ付きのバックアップファイル名
   - 最新のバックアップから自動復元機能

3. エラーハンドリングの強化
   - モニター情報取得失敗時のフォールバック処理
   - 重複名の自動解決（番号付加）
   - 設定ファイル破損時の復旧処理

### 実装方針
1. MonitorControllerの拡張
   - EDID情報を使用した詳細情報取得
   - 物理サイズのインチ単位への変換
   - 人間が識別可能な名前の生成

2. ConfigManagerの拡張
   - バックアップ機能の実装
   - デフォルト設定生成機能
   - 設定の自動検証と復旧

3. BrightnessDaemonの拡張
   - 起動時の設定チェック
   - 未設定モニターの自動追加
   - エラー発生時のユーザー通知

### 影響範囲
- MonitorController.h/cpp
- ConfigManager.h/cpp
- BrightnessDaemon.cpp
- 設定ファイル構造
- エラーハンドリングロジック

## 2025/03/03 - ドキュメント構造の再編成

### 背景
- 実装が完了し、開発フェーズから運用フェーズへの移行
- 開発中のドキュメントと運用に必要なドキュメントが混在
- ユーザーと開発者向けの情報が明確に分離されていない

### 決定事項
1. ドキュメントの2層構造化
   - ユーザー向けドキュメント（docs/user/）
   - 開発者向けドキュメント（docs/developer/）

2. ユーザー向けドキュメントの構成
   - getting_started.md: セットアップと基本的な使い方
   - configuration.md: 設定ファイルの説明
   - samples/: 設定ファイルのサンプル

3. 開発者向けドキュメントの構成
   - architecture.md: システム全体のアーキテクチャ
   - plugin_development.md: プラグイン開発ガイド
   - api_reference.md: APIリファレンス

4. 開発フェーズのドキュメントの扱い
   - 実装計画、タスク、修正計画は削除
   - 重要な設計決定はdecisionLog.mdに統合
   - 設計ドキュメントの内容は新構造に統合

### 実装方針
1. ドキュメントの再構成
   - 新しいディレクトリ構造の作成
   - 必要な情報の抽出と再編成
   - 不要なドキュメントの削除

2. 内容の更新
   - 最新の実装を反映
   - 実践的な例の追加
   - エラーケースの説明の充実

### 影響範囲
- すべてのドキュメントファイル
- Memory Bank
- サンプルファイル

## 2025/03/03 - プラグイン設定構造の再設計

### 背景
- SwitchBotがプラグインの一つとなったが、設定がルートレベルにある
- プラグイン固有の設定（token, secret）がグローバルな場所にある
- 新しいプラグインを追加する際の設計指針が不明確

### 決定事項
1. 設定ファイルの構造を階層化
   - プラグイン設定を "plugins" セクション下に移動
   - 各プラグインが独自の名前空間を持つ
   - プラグイン固有の設定を適切な場所に配置

2. 新しい設定構造の採用
   ```json
   {
     "plugins": {
       "switchbot": {
         "global_settings": {
           "token": "YOUR_TOKEN",
           "secret": "YOUR_SECRET"
         },
         "devices": []
       }
     }
   }
   ```

### 実装方針
1. ConfigManagerの拡張
   - プラグイン設定へのアクセス方法の追加
   - 後方互換性のための移行ロジック実装

2. プラグインの更新
   - 設定読み込みロジックの更新
   - エラーハンドリングの強化

### 影響範囲
- ConfigManager.h/cpp
- SwitchBotPlugin.h/cpp
- 設定ファイル構造
- テストケース

## 2025/03/02 - プラグインDLLのビルド時コピー処理の追加

### 背景
- BrightnessDaemonの実行ファイルと同じディレクトリにプラグインDLLが必要
- 現状はインストール時のみプラグインがコピーされる設定になっている

### 決定事項
1. ビルド時にプラグインDLLを自動的にコピーする機能を追加
   - BrightnessDaemonのビルド出力ディレクトリ下にpluginsディレクトリを作成
   - プラグインDLLを自動的にそのディレクトリにコピー
2. プラグイン単体でのビルド時にもコピー処理が実行されるように設定
   - 各プラグインのCMakeListsファイルにコピー処理を追加

### 実装方針
1. ルートCMakeListsファイルの変更
   - add_custom_commandとadd_custom_targetを使用してビルド後処理を追加
   - BrightnessDaemonのビルド後に実行されるように依存関係を設定

2. プラグインCMakeListsファイルの変更
   - 各プラグインのビルド後にDLLをコピーする処理を追加
   - BrightnessDaemonの出力ディレクトリを考慮したパス設定

### 影響範囲
- CMakeListsファイル（ルート）
- CMakeListsファイル（DummyLightSensor）
- CMakeListsファイル（SwitchBotLightSensor）
